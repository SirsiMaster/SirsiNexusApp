<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment | Sirsi Technologies</title>
    <!-- Security Integration -->
    <script src="/assets/js/security-init.js?v=20260203"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Frame Breaker: Ensure we are not stuck inside sign.html iframe
        if (window.top !== window.self) {
            window.top.location = window.self.location;
        }
    </script>

    <style>
        /* Immersive Background: Light Theme Premium */
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #0f172a;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .gold-text {
            color: #C8A951;
        }

        .gold-bg {
            background-color: #C8A951;
        }

        /* Subtle Grid Pattern for texture */
        .bg-pattern {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 32px 32px;
            opacity: 0.3;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05), 0 5px 15px -3px rgba(0, 0, 0, 0.02);
        }

        .payment-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            border: 1px solid #e2e8f0;
        }

        .payment-card:hover {
            transform: translateY(-3px);
            border-color: #cbd5e1;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.08);
        }

        .payment-card.selected {
            border-color: #C8A951;
            background: #FFFCF2;
            /* Very light gold tint */
            box-shadow: 0 0 0 1px #C8A951, 0 10px 25px -5px rgba(200, 169, 81, 0.15);
        }

        .dashed-line {
            background-image: linear-gradient(to right, #94a3b8 50%, rgba(255, 255, 255, 0) 0%);
            background-position: bottom;
            background-size: 8px 1px;
            background-repeat: repeat-x;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* Ticket styling */
        .ticket-wrapper {
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.1));
        }
    </style>
</head>

<body class="flex flex-col min-h-screen relative">

    <!-- Background Texture -->
    <div class="absolute inset-0 bg-pattern pointer-events-none z-0"></div>

    <!-- Navbar -->
    <nav class="border-b border-gray-200 bg-white/90 backdrop-blur-md sticky top-0 z-50 h-20 flex-none shadow-sm">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 bg-gradient-to-br from-[#C8A951] to-[#8A7130] rounded-sm transform rotate-45 shadow-md shadow-[#C8A951]/20">
                </div>
                <span class="font-serif font-bold text-xl tracking-widest text-[#0f172a]">SIRSI</span>
            </div>
            <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                <div class="w-2 h-2 rounded-full bg-[#10B981] animate-pulse"></div>
                ENCRYPTED TRANSACTION
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center p-6 relative z-10">

        <!-- Success Banner -->
        <div
            class="glass-panel rounded-full px-6 py-2 mb-8 flex items-center gap-3 border border-[#10B981]/20 bg-[#10B981]/10 animate-fade-in">
            <svg class="w-5 h-5 text-[#10B981]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="text-[#065f46] font-semibold tracking-wide text-sm">Agreement Successfully Executed</span>
        </div>

        <div class="w-full max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in"
            style="animation-delay: 0.1s;">

            <!-- LEFT: Payment Method -->
            <div class="lg:col-span-7 space-y-6">
                <div>
                    <h1 class="font-serif text-3xl md:text-4xl text-[#0f172a] mb-2 font-bold">Finalize Activation</h1>
                    <p class="text-gray-500">Select a payment method to activate your vault.</p>
                </div>

                <!-- Stripe -->
                <div id="card-stripe" onclick="selectPayment('stripe')"
                    class="payment-card rounded-xl p-1 cursor-pointer group selected">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-lg bg-[#635BFF] flex items-center justify-center text-white shadow-lg shadow-[#635BFF]/30">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                        <line x1="2" y1="10" x2="22" y2="10"></line>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-bold text-[#0f172a] group-hover:text-[#635BFF] transition-colors">
                                        Card Payment</h3>
                                    <p class="text-sm text-gray-500">Instant activation via Stripe</p>
                                </div>
                            </div>
                            <div
                                class="w-5 h-5 rounded-full border border-gray-300 group-[.selected]:border-[#C8A951] group-[.selected]:bg-[#C8A951] transition-colors flex items-center justify-center">
                                <svg class="w-3 h-3 text-white opacity-0 group-[.selected]:opacity-100" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>

                        <!-- Stripe Expanded -->
                        <div id="content-stripe" class="mt-4 pt-4 border-t border-gray-100">
                            <button id="btn-stripe-checkout" onclick="handleStripeRedirect()"
                                class="w-full py-4 rounded-lg bg-[#635BFF] hover:bg-[#5349E0] text-white font-bold tracking-wide shadow-lg shadow-[#635BFF]/20 transition-all flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                                <span>Pay Securely</span>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </button>
                            <div class="mt-3 flex gap-3 justify-center items-center">
                                <span
                                    class="flex items-center gap-1 px-2 py-1 bg-gray-50 rounded text-[10px] text-gray-500 border border-gray-200">
                                    <svg class="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    AES-256 ENCRYPTION
                                </span>
                                <span
                                    class="px-2 py-1 bg-gray-50 rounded text-[10px] text-gray-500 border border-gray-200">PCI
                                    DSS COMPLIANT</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wire Transfer -->
                <div id="card-chase" onclick="selectPayment('chase')"
                    class="payment-card rounded-xl p-1 cursor-pointer group">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-lg bg-[#117ACA] flex items-center justify-center text-white shadow-lg shadow-[#117ACA]/30">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                        <polyline points="2 17 12 22 22 17"></polyline>
                                        <polyline points="2 12 12 17 22 12"></polyline>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-xl font-bold text-[#0f172a] group-hover:text-[#117ACA] transition-colors">
                                        Bank Wire</h3>
                                    <p class="text-sm text-gray-500">JPMorgan Chase Commercial</p>
                                </div>
                            </div>
                            <div
                                class="w-5 h-5 rounded-full border border-gray-300 group-[.selected]:border-[#C8A951] group-[.selected]:bg-[#C8A951] transition-colors flex items-center justify-center">
                                <svg class="w-3 h-3 text-white opacity-0 group-[.selected]:opacity-100" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>

                        <!-- Bank Transfer Expanded - SECURE -->
                        <div id="content-chase" class="hidden mt-4 pt-4 border-t border-gray-100">
                            <!-- Secure Bank Transfer Info -->
                            <div
                                class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-5 border border-slate-200 mb-4 space-y-4">
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-[#117ACA]/10 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-[#117ACA]" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-[#0f172a] mb-1">Secure ACH Bank Transfer</h4>
                                        <p class="text-sm text-gray-500">Connect your bank securely via Plaid. No
                                            banking information is stored or displayed on this page for your protection.
                                        </p>
                                    </div>
                                </div>

                                <div
                                    class="flex items-center gap-2 text-xs text-gray-500 pt-2 border-t border-slate-200">
                                    <svg class="w-4 h-4 text-[#10B981]" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    <span>256-bit encryption</span>
                                    <span class="mx-1">‚Ä¢</span>
                                    <span>SOC 2 Type II Certified</span>
                                    <span class="mx-1">‚Ä¢</span>
                                    <span>Plaid Verified</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="space-y-3">
                                <button id="btn-ach-checkout" onclick="handleACHRedirect()"
                                    class="w-full py-4 rounded-lg bg-[#117ACA] hover:bg-[#0c63a5] text-white font-bold tracking-wide shadow-lg shadow-[#117ACA]/20 transition-all flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                    </svg>
                                    <span>Connect Bank Account (ACH)</span>
                                </button>

                                <div class="flex gap-2 justify-center">
                                    <button onclick="showWireInstructions()"
                                        class="flex-1 py-3 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold transition-all flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                        <span>View Wire Details</span>
                                    </button>
                                    <button onclick="requestWireInstructions()"
                                        class="flex-1 py-3 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold transition-all flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                        <span>Email Wire Details</span>
                                    </button>
                                </div>

                                <!-- Wire Instructions Display (Hidden by default) -->
                                <div id="wire-details-panel"
                                    class="hidden mt-4 p-5 bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl border border-blue-200">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-bold text-[#117ACA]">Wire Transfer Instructions</h4>
                                        <button onclick="hideWireInstructions()"
                                            class="text-slate-400 hover:text-slate-600">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                    <table class="w-full text-sm">
                                        <tbody>
                                            <tr>
                                                <td class="py-2 text-slate-500">Bank Name:</td>
                                                <td class="py-2 font-semibold text-slate-800">JPMORGAN CHASE BANK, N.A.
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 text-slate-500">Routing Number:</td>
                                                <td class="py-2 font-mono font-bold text-[#117ACA]">021000021</td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 text-slate-500">Account Number:</td>
                                                <td class="py-2 font-mono font-bold text-slate-800">2905276162</td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 text-slate-500">Beneficiary:</td>
                                                <td class="py-2 font-semibold text-slate-800">Sirsi Technologies Inc
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 text-slate-500">Reference:</td>
                                                <td class="py-2 font-mono" id="wire-reference">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <p class="text-xs text-amber-800">
                                            <strong>‚ö†Ô∏è Security Notice:</strong> Always verify wire details via a
                                            trusted channel before transferring funds.
                                            Contact <a href="mailto:accounts@sirsi.ai"
                                                class="underline">accounts@sirsi.ai</a> if you have any concerns.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Invoice Summary -->
            <div class="lg:col-span-5">
                <div class="sticky top-24 ticket-wrapper">
                    <!-- Ticket Header -->
                    <div class="bg-[#C8A951] rounded-t-xl p-6 text-[#0f172a] text-center relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/brushed-alum.png')] opacity-10">
                        </div>
                        <div class="relative z-10">
                            <div class="font-serif font-bold text-2xl tracking-wide  mb-1">INVOICE SUMMARY</div>
                            <div class="text-xs font-bold uppercase tracking-widest opacity-80">Reference: <span
                                    id="ref-header">LOADING</span></div>
                        </div>
                    </div>

                    <!-- Ticket Body -->
                    <div class="bg-white rounded-b-xl p-8 border border-gray-200 border-t-0 shadow-xl relative">
                        <!-- Perforated top shadow -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-b from-black/5 to-transparent">
                        </div>

                        <!-- Status -->
                        <div class="flex justify-between items-center mb-6 pb-6 border-b border-gray-200 dashed-line">
                            <span class="text-gray-400 text-sm uppercase tracking-wider font-semibold">Status</span>
                            <span
                                class="px-3 py-1 rounded-full bg-[#10B981]/10 text-[#10B981] text-xs font-bold border border-[#10B981]/20">MSA
                                SIGNED</span>
                        </div>

                        <!-- Line Items -->
                        <div class="space-y-5 mb-8">
                            <div class="flex justify-between items-start group">
                                <div>
                                    <div class="text-[#0f172a] font-medium text-lg" id="plan-name">Platform Services
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Initial Milestone Payment</div>
                                </div>
                                <div class="text-[#0f172a] font-mono font-medium" id="amount-line">$0.00</div>
                            </div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[#0f172a] font-medium text-lg">Compliance Fee</div>
                                    <div class="text-xs text-gray-500 mt-1">SOC 2 & ESIGN Verification</div>
                                </div>
                                <div class="text-[#0f172a] font-mono font-medium">Included</div>
                            </div>
                        </div>

                        <!-- Total -->
                        <div class="flex justify-between items-end mb-8 pt-6 border-t border-gray-200">
                            <span class="text-gray-400 text-sm uppercase tracking-wider font-bold">Total Due</span>
                            <span class="text-4xl font-serif text-[#C8A951] font-bold" id="amount-total">$0.00</span>
                        </div>

                        <!-- Contract Download -->
                        <div id="contract-download-section" class="hidden">
                            <a id="download-contract-btn" href="#" target="_blank"
                                class="block w-full py-4 bg-[#f8fafc] hover:bg-[#f1f5f9] border border-[#C8A951]/30 rounded-lg text-center transition-all group shadow-sm hover:shadow-md">
                                <span
                                    class="text-[#C8A951] text-xs font-bold uppercase tracking-widest group-hover:text-[#b09446] transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Download Executed MSA
                                </span>
                            </a>
                        </div>
                    </div>

                    <!-- Security Footer -->
                    <div class="mt-6 text-center">
                        <div class="flex justify-center gap-4 text-gray-400 mb-2">
                            <svg class="w-6 h-6 hover:text-gray-600 transition-colors" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                            </svg>
                            <svg class="w-6 h-6 hover:text-gray-600 transition-colors" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z" />
                            </svg>
                        </div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest">Bank-grade Security Standard</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="invoice-template" class="hidden"></div>

    <script>
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);

            // 1. Get Params
            const amount = parseFloat(urlParams.get('amount')) || 95000;
            const ref = urlParams.get('ref') || 'MSA-REF-001';
            const plan = urlParams.get('plan') || 'Platform Access';
            const envId = urlParams.get('envelope') || sessionStorage.getItem('envelopeId');

            console.log('Payment Init:', { amount, ref, plan, envId });

            // 2. Formatting
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
            const formattedAmount = formatter.format(amount);

            // 3. Update DOM
            const updates = {
                'amount-total': formattedAmount,
                'amount-line': formattedAmount,
                'ref-header': ref,
                'plan-name': decodeURIComponent(plan)
            };

            for (const [id, val] of Object.entries(updates)) {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
                else console.warn('Missing element:', id);
            }

            // 4. Handle Download Link
            if (envId) {
                const dlSection = document.getElementById('contract-download-section');
                const dlBtn = document.getElementById('download-contract-btn');

                // Get client name from URL or session
                const clientName = decodeURIComponent(urlParams.get('client') || '') || sessionStorage.getItem('signerName') || 'Client';

                // Construct PDF Link
                const pdfParams = new URLSearchParams({
                    plan: plan.replace('Plan ', '').trim(),
                    client: clientName,
                    date: new Date().toLocaleDateString(),
                    signed: 'true'
                });

                const pdfUrl = `/finalwishes/contracts/printable-msa.html?${pdfParams.toString()}`;

                if (dlBtn) dlBtn.href = pdfUrl;
                if (dlSection) dlSection.classList.remove('hidden');
            }
        });

        // Payment Logic
        window.selectPayment = function (method) {
            const stripeCard = document.getElementById('card-stripe');
            const chaseCard = document.getElementById('card-chase');
            const stripeContent = document.getElementById('content-stripe');
            const chaseContent = document.getElementById('content-chase');

            if (method === 'stripe') {
                stripeCard.classList.add('selected');
                chaseCard.classList.remove('selected');
                stripeContent.classList.remove('hidden');
                chaseContent.classList.add('hidden');
            } else {
                chaseCard.classList.add('selected');
                stripeCard.classList.remove('selected');
                chaseContent.classList.remove('hidden');
                stripeContent.classList.add('hidden');
            }
        };

        // API Endpoint - Cloud Run Gen2 Function
        const API_BASE = 'https://api-6kdf4or4qq-uc.a.run.app/api';

        // Secure ACH Bank Transfer via Stripe + Plaid
        window.handleACHRedirect = async function () {
            const btn = document.getElementById('btn-ach-checkout');
            const originalText = btn.innerHTML;

            const urlParams = new URLSearchParams(window.location.search);
            const amount = parseFloat(urlParams.get('amount')) || 95000;
            const ref = urlParams.get('ref') || 'MSA-REF-001';
            const projectId = urlParams.get('project') || sessionStorage.getItem('projectId') || 'sirsi';
            const envId = urlParams.get('envelope') || sessionStorage.getItem('envelopeId') || `temp-${Date.now()}`;

            btn.innerHTML = '<span class="animate-pulse">Connecting to Bank...</span>';
            btn.disabled = true;

            try {
                console.log('Initiating ACH session:', { envId, amount, projectId });

                // Use Stripe's ACH payment method type
                const response = await fetch(`${API_BASE}/payments/create-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        envelopeId: envId,
                        amount: Math.round(amount * 100),
                        projectId: projectId,
                        paymentMethodType: 'us_bank_account', // ACH via Plaid
                        successUrl: `${window.location.origin}/payment.html?status=success&envelope=${envId}&ref=${ref}`,
                        cancelUrl: `${window.location.origin}/payment.html?status=cancelled&envelope=${envId}&ref=${ref}`
                    })
                });

                if (!response.ok) {
                    const errInfo = await response.json();
                    throw new Error(errInfo.message || 'ACH session creation failed');
                }

                const data = await response.json();
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    throw new Error('No checkout URL returned');
                }

            } catch (error) {
                console.error('ACH Payment Error:', error);
                alert('Bank Connection Failed: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // Secure Wire Instructions Request
        window.requestWireInstructions = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref') || 'MSA-REF-001';
            const envId = urlParams.get('envelope') || sessionStorage.getItem('envelopeId');

            // Get signer email from session or prompt
            let email = sessionStorage.getItem('signerEmail');
            if (!email) {
                email = prompt('Enter your email to receive secure wire instructions:');
                if (!email || !email.includes('@')) {
                    alert('A valid email is required to receive wire instructions.');
                    return;
                }
            }

            try {
                // Send request to backend to email wire instructions securely
                const response = await fetch(`${API_BASE}/payments/request-wire-instructions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        reference: ref,
                        envelopeId: envId
                    })
                });

                if (!response.ok) {
                    const errInfo = await response.json();
                    throw new Error(errInfo.message || 'Request failed');
                }

                alert(`‚úÖ Secure wire instructions have been sent to ${email}.\n\nPlease check your email and spam folder.`);

            } catch (error) {
                console.error('Wire request error:', error);
                alert('Failed to send wire instructions. Please contact accounts@sirsi.ai directly.');
            }
        };

        // Show Wire Instructions Panel (No Email Required)
        window.showWireInstructions = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref') || 'MSA-REF-001';

            // Update reference on the panel
            const refEl = document.getElementById('wire-reference');
            if (refEl) refEl.textContent = ref;

            // Show the panel
            const panel = document.getElementById('wire-details-panel');
            if (panel) {
                panel.classList.remove('hidden');
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Log audit trail
            console.log('üìã Wire instructions displayed for reference:', ref);
        };

        // Hide Wire Instructions Panel
        window.hideWireInstructions = function () {
            const panel = document.getElementById('wire-details-panel');
            if (panel) panel.classList.add('hidden');
        };

        window.handleStripeRedirect = async function () {
            const btn = document.getElementById('btn-stripe-checkout');
            const originalText = btn.innerHTML;

            // Get current state
            const urlParams = new URLSearchParams(window.location.search);
            const amount = parseFloat(urlParams.get('amount')) || 95000;
            const ref = urlParams.get('ref') || 'MSA-REF-001';
            const projectId = urlParams.get('project') || sessionStorage.getItem('projectId') || 'sirsi';
            // Use session storage envelope if available, else generate a temp one
            const envId = urlParams.get('envelope') || sessionStorage.getItem('envelopeId') || `temp-${Date.now()}`;

            btn.innerHTML = '<span class="animate-pulse">Creating Secure Session...</span>';
            btn.disabled = true;

            try {
                console.log('Initiating Stripe session:', { envId, amount, projectId });

                const response = await fetch(`${API_BASE}/payments/create-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        envelopeId: envId,
                        amount: Math.round(amount * 100), // Request expects cents
                        projectId: projectId,
                        successUrl: `${window.location.origin}/payment.html?status=success&envelope=${envId}&ref=${ref}`,
                        cancelUrl: `${window.location.origin}/payment.html?status=cancelled&envelope=${envId}&ref=${ref}`
                    })
                });

                if (!response.ok) {
                    const errInfo = await response.json();
                    throw new Error(errInfo.message || 'Session creation failed');
                }

                const data = await response.json();
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    throw new Error('No checkout URL returned');
                }

            } catch (error) {
                console.error('Payment Error:', error);
                alert('Secure Payment Initialization Failed: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.generatePDF = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref') || 'MSA-REF-001';
            const amount = parseFloat(urlParams.get('amount')) || 95000;
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

            // Populate Template dynamically
            const template = document.createElement('div');
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            template.innerHTML = `
                <div style="font-family: 'Inter', sans-serif; padding: 40px; color: #1e293b; background: white; max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #C8A951; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <h1 style="margin: 0; color: #0f172a; font-family: 'Cinzel', serif; font-size: 28px;">INVOICE</h1>
                            <p style="margin: 5px 0 0; color: #64748b; font-size: 12px; text-transform: uppercase;">Reference: ${ref}</p>
                            <p style="margin: 2px 0 0; color: #64748b; font-size: 12px;">Date: ${today}</p>
                        </div>
                        <div style="text-align: right;">
                             <h2 style="margin: 0; color: #C8A951; font-family: 'Cinzel', serif; font-size: 18px;">SIRSI TECHNOLOGIES</h2>
                             <p style="margin: 5px 0 0; font-size: 12px; color: #64748b;">909 Rose Avenue, Suite 400<br>North Bethesda, MD 20852</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-left: 4px solid #C8A951; margin-bottom: 30px;">
                        <p style="margin: 0 0 5px; font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: bold;">Bill To</p>
                        <p style="margin: 0; font-size: 16px; font-weight: 600; color: #0f172a;">FinalWishes Inc.</p>
                        <p style="margin: 0; font-size: 14px; color: #475569;">Attn: The Client</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #0f172a; color: #C8A951;">
                                <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase;">Description</th>
                                <th style="padding: 12px; text-align: right; font-size: 12px; text-transform: uppercase;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 20px 12px; border-bottom: 1px solid #e2e8f0;">
                                    <strong>Initial Milestone Payment</strong><br>
                                    <span style="font-size: 12px; color: #64748b;">Master Services Agreement Execution - Payment 1 of 3</span>
                                </td>
                                <td style="padding: 20px 12px; border-bottom: 1px solid #e2e8f0; text-align: right; font-family: 'Cinzel', serif; font-size: 16px;">
                                    ${formatter.format(amount)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; padding: 20px; background: #fffcf2; border: 1px solid #C8A951; border-radius: 4px; margin-bottom: 40px;">
                        <span style="font-size: 12px; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-right: 15px;">Total Due</span>
                        <span style="font-size: 24px; font-family: 'Cinzel', serif; color: #C8A951; font-weight: bold;">${formatter.format(amount)}</span>
                    </div>
                    
                    <div style="background: #f0f9ff; border: 1px solid #b9e6fe; padding: 20px; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px; color: #0369a1; font-size: 14px; text-transform: uppercase;">Payment Instructions</h3>
                        <p style="margin: 0; font-size: 13px; color: #0f172a;">
                            <strong>Secure Payment Options:</strong><br>
                            ‚Ä¢ <strong>Card/ACH:</strong> Pay securely via our payment portal at <a href="https://sirsi-sign.web.app/payment.html">sirsi-sign.web.app</a><br>
                            ‚Ä¢ <strong>Wire Transfer:</strong> Contact <a href="mailto:accounts@sirsi.ai">accounts@sirsi.ai</a> for verified wire instructions
                        </p>
                        <p style="margin: 10px 0 0; font-size: 11px; color: #64748b;">
                            ‚ö†Ô∏è For your security, wire details are never displayed publicly. Instructions are provided via encrypted email after identity verification.
                        </p>
                    </div>
                </div>
             `;

            const opt = {
                margin: 0.5,
                filename: `Invoice_${ref}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(template).save();
        };
    </script>
    <!-- Footer for Policies -->
    <footer class="py-12 border-t border-gray-200 bg-white/80 text-center no-print mt-auto">
        <div class="max-w-4xl mx-auto px-6">
            <div class="flex justify-center gap-8 mb-4">
                <a href="/privacy.html"
                    class="text-xs uppercase tracking-widest text-gray-500 hover:text-[#C8A951] transition-colors">Privacy
                    Policy</a>
                <a href="/terms.html"
                    class="text-xs uppercase tracking-widest text-gray-500 hover:text-[#C8A951] transition-colors">Terms
                    of Service</a>
                <a href="/security.html"
                    class="text-xs uppercase tracking-widest text-gray-500 hover:text-[#C8A951] transition-colors">Security</a>
            </div>
            <p class="text-[10px] text-gray-400 uppercase tracking-widest">&copy; 2026 Sirsi Technologies Inc.. All
                Rights
                Reserved.</p>
        </div>
    </footer>
</body>

</html>